@page "/modules"
@using Modulus.Host.Blazor.Shell.ViewModels
@using Markdig
@using Microsoft.AspNetCore.Components.Forms
@inject ModuleListViewModel ViewModel

<MudText Typo="Typo.h4" GutterBottom="true">Modules</MudText>
<MudText Typo="Typo.body2" Class="mb-4">Manage installed modules and plugins</MudText>

@if (!string.IsNullOrEmpty(ViewModel.ErrorMessage))
{
    <MudAlert Severity="Severity.Error" Class="mb-4" ShowCloseIcon="true" CloseIconClicked="@(() => ViewModel.ErrorMessage = null)">
        @ViewModel.ErrorMessage
    </MudAlert>
}

@if (!string.IsNullOrEmpty(ViewModel.SuccessMessage))
{
    <MudAlert Severity="Severity.Success" Class="mb-4" ShowCloseIcon="true" CloseIconClicked="@(() => ViewModel.SuccessMessage = null)">
        @ViewModel.SuccessMessage
    </MudAlert>
}

<MudGrid Spacing="3">
    <!-- Left: Module List -->
    <MudItem xs="12" md="3">
        <MudPaper Class="pa-0" Elevation="0" Outlined="true" Style="height: calc(100vh - 200px); overflow-y: auto;">
            <MudText Typo="Typo.subtitle1" Class="pa-4 pb-2">Installed Modules</MudText>
            <MudList T="ModuleViewModel" @bind-SelectedValue="ViewModel.SelectedModule" Color="Color.Primary">
                @foreach (var module in ViewModel.Modules)
                {
                    <MudListItem Value="@module" OnClick="@(() => ViewModel.SelectedModule = module)">
                        <div class="d-flex align-center">
                            <MudCheckBox T="bool" Value="@module.IsRunning" Disabled="true" Dense="true" Size="Size.Small" Color="@GetColor(module.StatusColor)" Class="mr-2" />
                            <div>
                                <MudText Typo="Typo.body2">@module.Name</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">v@module.Version</MudText>
                            </div>
                        </div>
                    </MudListItem>
                }
            </MudList>
        </MudPaper>
    </MudItem>

    <!-- Middle: Details -->
    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4" Elevation="0" Outlined="true" Style="height: calc(100vh - 200px); overflow-y: auto;">
            @if (ViewModel.SelectedModule != null)
            {
                var module = ViewModel.SelectedModule;
                <div class="d-flex justify-space-between align-start mb-4">
                    <div>
                        <MudText Typo="Typo.h5">@module.Name</MudText>
                        <MudStack Row="true" Spacing="2" Class="mt-1">
                            <MudText Typo="Typo.caption">v@module.Version</MudText>
                            <MudText Typo="Typo.caption">â€¢</MudText>
                            <MudText Typo="Typo.caption">@module.Author</MudText>
                        </MudStack>
                    </div>
                    <MudStack Row="true">
                        @if (module.ShowToggle)
                        {
                            if (module.IsRunning)
                            {
                                <MudButton Variant="Variant.Outlined" Color="Color.Warning" Size="Size.Small" OnClick="@(() => ToggleModule(module))">Disable</MudButton>
                            }
                            else
                            {
                                <MudButton Variant="Variant.Filled" Color="Color.Success" Size="Size.Small" OnClick="@(() => ToggleModule(module))">Enable</MudButton>
                            }
                        }
                        @if (module.CanRemove)
                        {
                            <MudButton Variant="Variant.Text" Color="Color.Error" Size="Size.Small" OnClick="@(() => RemoveModule(module))">Uninstall</MudButton>
                        }
                    </MudStack>
                </div>

                <MudDivider Class="mb-4" />

                <MudText Typo="Typo.subtitle2" GutterBottom="true">Description</MudText>
                
                <!-- Markdown Rendering -->
                <div class="markdown-body">
                    @((MarkupString)Markdown.ToHtml(ViewModel.SelectedModuleDetails ?? ""))
                </div>

                <MudText Typo="Typo.subtitle2" Class="mt-6" GutterBottom="true">Status</MudText>
                <MudChip T="string" Size="Size.Small" Color="@GetColor(module.StatusColor)" Variant="Variant.Filled">@module.StatusText</MudChip>
            }
            else
            {
                <div class="d-flex justify-center align-center h-100">
                    <MudText Typo="Typo.body1" Color="Color.Secondary">Select a module to view details</MudText>
                </div>
            }
        </MudPaper>
    </MudItem>

    <!-- Right: Actions -->
    <MudItem xs="12" md="3">
        <MudStack Spacing="3">
            <!-- Install Package Card -->
            <MudPaper Class="pa-4" Elevation="0" Outlined="true">
                <MudText Typo="Typo.subtitle2" Class="mb-3">Install Module</MudText>
                <MudFileUpload T="IBrowserFile" Accept=".modpkg" OnFilesChanged="OnPackageFileSelected" MaximumFileCount="1">
                    <ActivatorContent>
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" 
                                   StartIcon="@MudBlazor.Icons.Material.Filled.CloudUpload"
                                   Disabled="@ViewModel.IsLoading">
                            @if (ViewModel.IsLoading)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                <text>Installing...</text>
                            }
                            else
                            {
                                <text>Install from Package...</text>
                            }
                        </MudButton>
                    </ActivatorContent>
                </MudFileUpload>
                
                <MudDivider Class="my-3" />
                
                <MudButton Variant="Variant.Text" StartIcon="@MudBlazor.Icons.Material.Filled.Refresh" FullWidth="true" OnClick="@RefreshModules" Class="mt-2">
                    Refresh List
                </MudButton>
            </MudPaper>

            <!-- Stats Card -->
            <MudPaper Class="pa-4" Elevation="0" Outlined="true">
                <MudText Typo="Typo.subtitle2" Class="mb-2">Overview</MudText>
                <MudGrid>
                    <MudItem xs="6">
                        <MudText Typo="Typo.h4" Color="Color.Success">@ViewModel.Modules.Count(m => m.IsRunning)</MudText>
                        <MudText Typo="Typo.caption">Enabled</MudText>
                    </MudItem>
                    <MudItem xs="6">
                        <MudText Typo="Typo.h4">@ViewModel.Modules.Count(m => !m.IsRunning)</MudText>
                        <MudText Typo="Typo.caption">Disabled</MudText>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </MudStack>
    </MudItem>
</MudGrid>

<!-- Overwrite Confirmation Dialog -->
<MudDialog @bind-Visible="ViewModel.ShowOverwriteConfirm">
    <TitleContent>
        <MudText Typo="Typo.h6">Module Already Exists</MudText>
    </TitleContent>
    <DialogContent>
        <MudText>Module '@(ViewModel.PendingModuleName ?? ViewModel.PendingModuleId)' is already installed. Do you want to overwrite it?</MudText>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@CancelOverwrite">Cancel</MudButton>
        <MudButton Color="Color.Warning" Variant="Variant.Filled" OnClick="@ConfirmOverwrite">Overwrite</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private IBrowserFile? _pendingFile;
    private MemoryStream? _pendingFileStream;

    protected override async Task OnInitializedAsync()
    {
        await RefreshModules();
    }

    private async Task RefreshModules()
    {
        await ViewModel.RefreshModulesAsync();
        StateHasChanged();
    }

    private async Task ToggleModule(ModuleViewModel module)
    {
        await ViewModel.ToggleModuleAsync(module);
        StateHasChanged();
    }

    private async Task RemoveModule(ModuleViewModel module)
    {
        await ViewModel.RemoveModuleAsync(module);
        StateHasChanged();
    }

    private async Task OnPackageFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;

        if (!file.Name.EndsWith(".modpkg", StringComparison.OrdinalIgnoreCase))
        {
            ViewModel.ErrorMessage = "Please select a .modpkg file.";
            StateHasChanged();
            return;
        }

        _pendingFile = file;
        
        // Copy to memory stream for potential retry on overwrite
        _pendingFileStream?.Dispose();
        _pendingFileStream = new MemoryStream();
        await file.OpenReadStream(maxAllowedSize: 100 * 1024 * 1024).CopyToAsync(_pendingFileStream); // 100MB max
        _pendingFileStream.Position = 0;

        await ViewModel.InstallFromStreamAsync(_pendingFileStream, file.Name);
        
        // If no confirmation needed, clean up
        if (!ViewModel.ShowOverwriteConfirm)
        {
            CleanupPendingFile();
        }
        
        StateHasChanged();
    }

    private async Task ConfirmOverwrite()
    {
        if (_pendingFile != null && _pendingFileStream != null)
        {
            _pendingFileStream.Position = 0;
            await ViewModel.ConfirmOverwriteAsync(_pendingFileStream, _pendingFile.Name);
            CleanupPendingFile();
        }
        StateHasChanged();
    }

    private void CancelOverwrite()
    {
        ViewModel.CancelOverwrite();
        CleanupPendingFile();
        StateHasChanged();
    }

    private void CleanupPendingFile()
    {
        _pendingFileStream?.Dispose();
        _pendingFileStream = null;
        _pendingFile = null;
    }

    private Color GetColor(string statusColor) => statusColor switch
    {
        "success" => Color.Success,
        "warning" => Color.Warning,
        "error" => Color.Error,
        "secondary" => Color.Default,
        _ => Color.Info
    };

    public void Dispose()
    {
        _pendingFileStream?.Dispose();
    }
}
