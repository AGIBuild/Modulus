<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:Modulus.Host.Avalonia.Shell.ViewModels"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
             x:Class="Modulus.Host.Avalonia.Shell.Views.ModuleListView"
             x:DataType="vm:ModuleListViewModel">
  <Grid RowDefinitions="Auto, Auto, *">
      <!-- Header -->
      <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
          <TextBlock Text="Modules" FontSize="28" FontWeight="Light" VerticalAlignment="Center" 
                     Foreground="{DynamicResource PrimaryTextBrush}" Margin="0,0,20,0"/>
          <Button Command="{Binding RefreshModulesCommand}" ToolTip.Tip="Refresh module list">
              <TextBlock Text="ðŸ”„" FontSize="16"/>
          </Button>
      </StackPanel>
      
      <!-- Description -->
      <TextBlock Grid.Row="1" Text="Manage installed modules and plugins" 
                 Foreground="{DynamicResource SecondaryTextBrush}" Margin="0,0,0,20"/>
      
      <!-- Module Cards -->
      <ScrollViewer Grid.Row="2">
          <ItemsControl ItemsSource="{Binding Modules}">
              <ItemsControl.ItemsPanel>
                  <ItemsPanelTemplate>
                      <WrapPanel />
                  </ItemsPanelTemplate>
              </ItemsControl.ItemsPanel>
              <ItemsControl.ItemTemplate>
                  <DataTemplate x:DataType="vm:ModuleViewModel">
                      <Border Width="300" MinHeight="180" Margin="0,0,16,16" CornerRadius="8" 
                              Background="{DynamicResource CardBackgroundBrush}" 
                              BorderBrush="{DynamicResource CardBorderBrush}"
                              BorderThickness="1">
                          <Grid RowDefinitions="Auto, *, Auto" Margin="16">
                              <!-- Header -->
                              <Grid ColumnDefinitions="Auto, *, Auto">
                                  <Border Width="44" Height="44" CornerRadius="22" 
                                          Background="{DynamicResource SurfaceActiveBrush}" Margin="0,0,12,0">
                                      <TextBlock Text="{Binding DisplayName[0]}" 
                                                 HorizontalAlignment="Center" VerticalAlignment="Center" 
                                                 Foreground="White" FontWeight="Bold" FontSize="18"/>
                                  </Border>
                                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                      <TextBlock Text="{Binding DisplayName}" FontWeight="SemiBold" FontSize="14"
                                                 TextTrimming="CharacterEllipsis"
                                                 Foreground="{DynamicResource PrimaryTextBrush}"/>
                                      <TextBlock Text="{Binding Version, StringFormat='v{0}'}" FontSize="11" 
                                                 Foreground="{DynamicResource TertiaryTextBrush}"/>
                                  </StackPanel>
                                  <!-- Status Badge -->
                                  <Border Grid.Column="2" CornerRadius="10" Padding="8,3" VerticalAlignment="Top"
                                          Background="{DynamicResource SurfaceBrush}">
                                      <TextBlock Text="{Binding State}" FontSize="10" FontWeight="Medium"
                                                 Foreground="{DynamicResource SecondaryTextBrush}"/>
                                  </Border>
                              </Grid>
                              
                              <!-- Content -->
                              <StackPanel Grid.Row="1" Margin="0,12,0,0" Spacing="6">
                                  <TextBlock Text="{Binding Description}" FontSize="12" TextWrapping="Wrap" 
                                             Foreground="{DynamicResource SecondaryTextBrush}" 
                                             MaxLines="2" TextTrimming="CharacterEllipsis"
                                             IsVisible="{Binding Description, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                                  <StackPanel Orientation="Horizontal" Spacing="8">
                                      <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="4" Padding="6,2"
                                              IsVisible="{Binding IsSystem}">
                                          <TextBlock Text="System" FontSize="10" 
                                                     Foreground="{DynamicResource TertiaryTextBrush}"/>
                                      </Border>
                                  </StackPanel>
                              </StackPanel>
                              
                              <!-- Actions -->
                              <Grid Grid.Row="2" ColumnDefinitions="*, 8, *" Margin="0,12,0,0">
                                  <!-- Load Button (when unloaded) -->
                                  <Button Grid.Column="0" Content="Load" HorizontalAlignment="Stretch" 
                                          HorizontalContentAlignment="Center"
                                          Command="{Binding $parent[UserControl].((vm:ModuleListViewModel)DataContext).ToggleModuleCommand}" 
                                          CommandParameter="{Binding}" 
                                          IsVisible="{Binding IsUnloaded}"/>
                                          
                                  <!-- Unload Button (when loaded and not system) -->
                                  <Button Grid.Column="0" Content="Unload" HorizontalAlignment="Stretch" 
                                          HorizontalContentAlignment="Center"
                                          Command="{Binding $parent[UserControl].((vm:ModuleListViewModel)DataContext).ToggleModuleCommand}" 
                                          CommandParameter="{Binding}" 
                                          IsVisible="{Binding CanUnload}"/>

                                  <!-- Reload Button (when loaded) -->
                                  <Button Grid.Column="2" Content="Reload" HorizontalAlignment="Stretch" 
                                          HorizontalContentAlignment="Center"
                                          Command="{Binding $parent[UserControl].((vm:ModuleListViewModel)DataContext).ReloadModuleCommand}" 
                                          CommandParameter="{Binding}"
                                          IsVisible="{Binding IsLoaded}"/>
                              </Grid>
                          </Grid>
                      </Border>
                  </DataTemplate>
              </ItemsControl.ItemTemplate>
          </ItemsControl>
      </ScrollViewer>
  </Grid>
</UserControl>
